---
import { GITHUB_USERNAME } from 'astro:env/server'
import type { IssuesSearchResponse } from '@/types/github'

export interface Props {
	data: IssuesSearchResponse
}

const { data } = Astro.props

// Validate props
if (!data?.items) {
	throw new Error('GitHub data is missing or invalid')
}

// Filter out PRs to own repositories
const excludeOwnedItems = data.items.filter((pr) => {
	const repoPath = pr.repository_url.split('/').slice(-2).join('/')
	const [owner = ''] = repoPath.split('/')
	return owner.toLowerCase() !== GITHUB_USERNAME.toLowerCase()
})

// Sort by merged date (descending)
const mergedPrs = excludeOwnedItems.sort((a, b) => {
	const aTime = new Date(a.pull_request.merged_at).getTime()
	const bTime = new Date(b.pull_request.merged_at).getTime()
	return bTime - aTime
})

// Format merged date for display
const mergedPrsInDesc = mergedPrs.map((pr) => {
	const d = new Date(pr.pull_request.merged_at)
	const mergedAtFmt = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`
	return { ...pr, mergedAtFmt }
})
---

<section class="flex flex-col gap-4">
	<h2 class="text-2xl font-semibold text-white text-center sm:text-left">
		ðŸ§© OSS ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
	</h2>

	<div class="grid grid-rows-subgrid grid-cols-1 gap-4 md:overflow-auto">
		{
			mergedPrsInDesc.map((pr) => {
				const repoName = pr.repository_url.split('/').slice(-2).join('/')
				return (
					<a
						href={pr.html_url}
						target="_blank"
						rel="noopener noreferrer"
						class="grid gap-2 bg-neutral-900 p-4 rounded-xl hover:bg-neutral-800 transition border border-neutral-800"
					>
						<div class="overflow-hidden">
							<h3 class="text-sm sm:text-base font-semibold text-white truncate">
								{pr.title}
							</h3>
							<p class="text-xs sm:text-sm text-gray-400 line-clamp-2 truncate">
								{repoName}
							</p>
						</div>
						<p class="text-xs text-gray-500">
							#{pr.number} â€¢ {pr.mergedAtFmt}
						</p>
					</a>
				)
			})
		}
	</div>
</section>
