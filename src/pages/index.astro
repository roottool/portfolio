---
import Layout from '../layouts/Layout.astro'
import GitHubContributions from '../components/GitHubContributions.astro'
import SteamSummary from '../components/SteamSummary.astro'
import SpotifyRecent from '../components/SpotifyRecent.astro'
import { config } from '@/lib/config'
import { fetchSteamLibrary } from '@/lib/api/steam'
import type { OssContribution } from '@/types/github'
import type { OwnedGamesResponse } from '@/types/steam'
import ossContributions from '@/assets/oss-contributions.json'

let steam: OwnedGamesResponse | null = null
let errorMessage: string | null = null

const github: OssContribution[] = ossContributions as OssContribution[]

try {
	const steamData = await fetchSteamLibrary(
		config.steam.apiKey,
		config.steam.steamId,
	)
	steam = steamData.response
} catch (error) {
	console.error('Steam API fetch failed:', error)
	errorMessage = error instanceof Error
		? error.message
		: 'Unknown error occurred'
}
---

<Layout>
	{errorMessage && (
		<div class="bg-red-900/20 border border-red-800 text-red-400 p-4 rounded-xl">
			<p class="font-semibold">エラーが発生しました</p>
			<p class="text-sm mt-1">{errorMessage}</p>
		</div>
	)}
	<GitHubContributions data={github} />
	<SpotifyRecent />
	{steam && <SteamSummary data={steam} />}
</Layout>
