---
import Layout from '../layouts/Layout.astro'
import GitHubContributions from '../components/GitHubContributions.astro'
import SteamSummary from '../components/SteamSummary.astro'
import SpotifyRecent from '../components/SpotifyRecent.astro'
import { config } from '@/lib/config'
import { fetchGitHubContributions } from '@/lib/api/github'
import { fetchSteamLibrary } from '@/lib/api/steam'
import type { IssuesSearchResponse } from '@/types/github'
import type { OwnedGamesResponse } from '@/types/steam'

let github: IssuesSearchResponse | null = null
let steam: OwnedGamesResponse | null = null
let errorMessage: string | null = null

try {
	const [githubData, steamData] = await Promise.all([
		fetchGitHubContributions(config.github.username),
		fetchSteamLibrary(config.steam.apiKey, config.steam.steamId),
	])
	github = githubData
	steam = steamData.response
} catch (error) {
	console.error('API fetch failed:', error)
	errorMessage = error instanceof Error
		? error.message
		: 'Unknown error occurred'
}
---

<Layout>
	{errorMessage && (
		<div class="bg-red-900/20 border border-red-800 text-red-400 p-4 rounded-xl">
			<p class="font-semibold">エラーが発生しました</p>
			<p class="text-sm mt-1">{errorMessage}</p>
		</div>
	)}
	{github && <GitHubContributions data={github} />}
	<SpotifyRecent />
	{steam && <SteamSummary data={steam} />}
</Layout>
